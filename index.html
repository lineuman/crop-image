<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>图片裁剪工具</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f7fa;
      margin: 0;
      padding: 20px;
      color: #333;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.08);
      position: relative;
    }

    h1 {
      text-align: center;
      color: #2c3e50;
      margin-bottom: 5px;
    }

    .subtitle {
      text-align: center;
      color: #7f8c8d;
      margin-top: 0;
      margin-bottom: 25px;
    }

    .upload-container {
      text-align: center;
      margin: 25px 0;
      padding: 25px;
      border: 2px dashed #dce4ec;
      border-radius: 8px;
      background: #f9fbfd;
      transition: all 0.3s;
    }

    .upload-container:hover {
      border-color: #3498db;
      background: #f0f7ff;
    }

    input[type="file"] {
      display: block;
      margin: 0 auto 15px;
      padding: 10px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 4px;
      width: 80%;
      max-width: 300px;
    }

    .canvas-container {
      position: relative;
      margin: 20px auto;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      overflow: hidden;
      max-width: 100%;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    #imageCanvas {
      display: block;
      max-width: 100%;
      cursor: crosshair;
    }

    #selectionBox {
      position: absolute;
      top: 0;
      left: 0;
      pointer-events: none;
      border: 2px dashed #e74c3c;
      background-color: rgba(231, 76, 60, 0.1);
      display: none;
    }

    .controls {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin: 25px 0;
    }

    button {
      padding: 12px 24px;
      font-size: 16px;
      cursor: pointer;
      border: none;
      border-radius: 6px;
      transition: all 0.2s;
      font-weight: 600;
    }

    #cropButton {
      background: #2ecc71;
      color: white;
    }

    #cropButton:hover:not(:disabled) {
      background: #27ae60;
    }

    #resetButton {
      background: #e74c3c;
      color: white;
    }

    #resetButton:hover {
      background: #c0392b;
    }

    #saveAllButton {
      background: #3498db;
      color: white;
    }

    #saveAllButton:hover:not(:disabled) {
      background: #2980b9;
    }

    button:disabled {
      cursor: not-allowed;
      opacity: 0.6;
      transform: none;
    }

    button:not(:disabled):hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .results-container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-top: 30px;
    }

    .result-section {
      flex: 1;
      min-width: 300px;
      background: #f9fbfd;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .result-section h3 {
      margin-top: 0;
      color: #2c3e50;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }

    .cropped-item {
      margin-bottom: 20px;
      padding: 15px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      transition: transform 0.2s;
    }

    .cropped-item:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    }

    .cropped-item img {
      max-width: 100%;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
    }

    .cropped-item-actions {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
    }

    .cropped-item-actions button {
      padding: 8px 15px;
      font-size: 14px;
    }

    .download-btn {
      background: #3498db;
      color: white;
    }

    .delete-btn {
      background: #e74c3c;
      color: white;
    }

    .empty-state {
      text-align: center;
      padding: 30px;
      color: #7f8c8d;
    }

    .instructions {
      background: #fff8e1;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
      border-left: 4px solid #ffc107;
    }

    .instructions h4 {
      margin-top: 0;
      color: #e65100;
    }

    .instructions ol {
      padding-left: 20px;
    }

    .instructions li {
      margin-bottom: 8px;
    }

    /* 语言切换器样式 */
    .language-switcher {
      position: absolute;
      top: 20px;
      right: 20px;
      display: flex;
      gap: 5px;
    }

    .lang-btn {
      padding: 6px 12px;
      background: #f1f2f6;
      border: 1px solid #ddd;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }

    .lang-btn.active {
      background: #3498db;
      color: white;
      border-color: #2980b9;
    }
  </style>
</head>
<body>

  <div class="container">
    <!-- 语言切换器 -->
    <div class="language-switcher">
      <button class="lang-btn active" data-lang="zh">中文</button>
      <button class="lang-btn" data-lang="en">English</button>
    </div>

    <h1 data-i18n="title">多图片裁剪工具</h1>
    <p class="subtitle" data-i18n="subtitle">上传图片，选择区域裁剪，保存多个裁剪结果</p>

    <div class="upload-container">
      <input type="file" id="imageUpload" accept="image/*" />
      <p data-i18n="uploadTip">支持JPG、PNG等常见图片格式，最大尺寸不超过5MB</p>
    </div>

    <div class="instructions">
      <h4 data-i18n="instructionsTitle">使用说明：</h4>
      <ol>
        <li data-i18n="instruction1">上传一张图片</li>
        <li data-i18n="instruction2">在图片上拖动鼠标选择要裁剪的区域</li>
        <li data-i18n="instruction3">点击"裁剪"按钮将选区添加到结果列表</li>
        <li data-i18n="instruction4">可以重复裁剪多个区域</li>
        <li data-i18n="instruction5">点击"下载"按钮保存单个裁剪图片，或点击"全部下载"保存所有裁剪图片</li>
      </ol>
    </div>

    <div class="canvas-container" id="canvasContainer">
      <canvas id="imageCanvas"></canvas>
      <div id="selectionBox"></div>
    </div>

    <div class="controls">
      <button id="cropButton" disabled data-i18n="cropBtn">裁剪</button>
      <button id="resetButton" data-i18n="resetBtn">重置选择</button>
      <button id="saveAllButton" disabled data-i18n="saveAllBtn">全部下载</button>
    </div>

    <div class="results-container">
      <div class="result-section">
        <h3 data-i18n="resultsTitle">裁剪结果（<span id="cropCount">0</span>）</h3>
        <div id="croppedResults"></div>
      </div>
    </div>
  </div>

  <script>
    // 多语言资源
    const i18nResources = {
      'zh': {
        'title': '多图片裁剪工具',
        'subtitle': '上传图片，选择区域裁剪，保存多个裁剪结果',
        'uploadTip': '支持JPG、PNG等常见图片格式，最大尺寸不超过5MB',
        'instructionsTitle': '使用说明：',
        'instruction1': '上传一张图片',
        'instruction2': '在图片上拖动鼠标选择要裁剪的区域',
        'instruction3': '点击"裁剪"按钮将选区添加到结果列表',
        'instruction4': '可以重复裁剪多个区域',
        'instruction5': '点击"下载"按钮保存单个裁剪图片，或点击"全部下载"保存所有裁剪图片',
        'cropBtn': '裁剪',
        'resetBtn': '重置选择',
        'saveAllBtn': '全部下载',
        'resultsTitle': '裁剪结果',
        'noResults': '暂无裁剪结果，请先裁剪图片',
        'sizeLabel': '尺寸',
        'downloadBtn': '下载',
        'deleteBtn': '删除',
        'selectArea': '请先选择裁剪区域！',
        'selectLarger': '请拖动选择一个更大的区域！',
        'fileTooLarge': '图片大小不能超过5MB'
      },
      'en': {
        'title': 'Image Cropping Tool',
        'subtitle': 'Upload image, select area to crop, save multiple cropping results',
        'uploadTip': 'Supports JPG, PNG and other common image formats, maximum size 5MB',
        'instructionsTitle': 'Instructions:',
        'instruction1': 'Upload an image',
        'instruction2': 'Drag on the image to select the area to crop',
        'instruction3': 'Click the "Crop" button to add the selection to the results list',
        'instruction4': 'You can crop multiple areas repeatedly',
        'instruction5': 'Click "Download" to save a single cropped image, or "Download All" to save all cropped images',
        'cropBtn': 'Crop',
        'resetBtn': 'Reset Selection',
        'saveAllBtn': 'Download All',
        'resultsTitle': 'Cropping Results',
        'noResults': 'No cropping results yet, please crop an image first',
        'sizeLabel': 'Size',
        'downloadBtn': 'Download',
        'deleteBtn': 'Delete',
        'selectArea': 'Please select a cropping area first!',
        'selectLarger': 'Please drag to select a larger area!',
        'fileTooLarge': 'Image size cannot exceed 5MB'
      }
    };

    // 获取DOM元素
    const imageUpload = document.getElementById('imageUpload');
    const imageCanvas = document.getElementById('imageCanvas');
    const ctx = imageCanvas.getContext('2d');
    const cropButton = document.getElementById('cropButton');
    const resetButton = document.getElementById('resetButton');
    const saveAllButton = document.getElementById('saveAllButton');
    const selectionBox = document.getElementById('selectionBox');
    const croppedResults = document.getElementById('croppedResults');
    const cropCount = document.getElementById('cropCount');
    const langButtons = document.querySelectorAll('.lang-btn');

    let img = new Image();
    let isDrawing = false;
    let startX, startY, endX, endY;
    let croppedImages = [];
    let currentLang = 'zh'; // 默认语言

    // 设置语言
    function setLanguage(lang) {
      currentLang = lang;
      
      // 更新语言按钮状态
      langButtons.forEach(btn => {
        if (btn.dataset.lang === lang) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });
      
      // 更新所有文本
      document.querySelectorAll('[data-i18n]').forEach(element => {
        const key = element.getAttribute('data-i18n');
        if (i18nResources[lang][key]) {
          if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
            element.placeholder = i18nResources[lang][key];
          } else {
            element.textContent = i18nResources[lang][key];
          }
        }
      });
      
      // 更新动态内容
      updateCroppedResults();
      
      // 保存语言选择
      localStorage.setItem('preferredLanguage', lang);
    }

    // 初始化语言
    const savedLanguage = localStorage.getItem('preferredLanguage');
    if (savedLanguage && i18nResources[savedLanguage]) {
      setLanguage(savedLanguage);
    }

    // 语言切换事件
    langButtons.forEach(button => {
      button.addEventListener('click', () => {
        const lang = button.getAttribute('data-lang');
        setLanguage(lang);
      });
    });

    // 上传新图片时重置所有状态
    imageUpload.addEventListener('change', function (e) {
      const file = e.target.files[0];
      if (!file) return;

      // 检查文件大小（不超过5MB）
      if (file.size > 5 * 1024 * 1024) {
        alert(i18nResources[currentLang]['fileTooLarge']);
        return;
      }

      // 重置选择状态但保留裁剪历史
      resetSelection();

      const reader = new FileReader();
      reader.onload = function (event) {
        img.src = event.target.result;
        img.onload = function () {
          const maxWidth = 700;
          let width = img.width;
          let height = img.height;
          if (width > maxWidth) {
            height = (maxWidth / width) * height;
            width = maxWidth;
          }
          imageCanvas.width = width;
          imageCanvas.height = height;

          // 清除画布并绘制新图
          ctx.clearRect(0, 0, width, height);
          ctx.drawImage(img, 0, 0, width, height);

          cropButton.disabled = false;
        };
      };
      reader.readAsDataURL(file);
    });

    function resetSelection() {
      // 清除选择框
      selectionBox.style.display = 'none';
      // 重置坐标
      startX = startY = endX = endY = undefined;
      isDrawing = false;
      
      // 重绘原始图像
      if (img.src) {
        ctx.clearRect(0, 0, imageCanvas.width, imageCanvas.height);
        ctx.drawImage(img, 0, 0, imageCanvas.width, imageCanvas.height);
      }
    }

    function resetAll() {
      // 清除所有状态
      resetSelection();
      // 清除裁剪历史
      croppedImages = [];
      updateCroppedResults();
      // 禁用按钮
      cropButton.disabled = true;
      saveAllButton.disabled = true;
      // 清除文件输入
      imageUpload.value = '';
    }

    // 鼠标事件
    imageCanvas.addEventListener('mousedown', startSelect);
    imageCanvas.addEventListener('mousemove', drawSelect);
    imageCanvas.addEventListener('mouseup', stopSelect);
    imageCanvas.addEventListener('mouseout', stopSelect);

    function startSelect(e) {
      if (!img.src) return;
      
      const rect = imageCanvas.getBoundingClientRect();
      startX = e.clientX - rect.left;
      startY = e.clientY - rect.top;
      isDrawing = true;
    }

    function drawSelect(e) {
      if (!isDrawing) return;

      const rect = imageCanvas.getBoundingClientRect();
      endX = e.clientX - rect.left;
      endY = e.clientY - rect.top;

      // 重绘图像
      ctx.clearRect(0, 0, imageCanvas.width, imageCanvas.height);
      ctx.drawImage(img, 0, 0, imageCanvas.width, imageCanvas.height);

      const x = Math.min(startX, endX);
      const y = Math.min(startY, endY);
      const w = Math.abs(endX - startX);
      const h = Math.abs(endY - startY);

      // 显示选择框
      selectionBox.style.display = 'block';
      selectionBox.style.left = x + 'px';
      selectionBox.style.top = y + 'px';
      selectionBox.style.width = w + 'px';
      selectionBox.style.height = h + 'px';
    }

    function stopSelect() {
      isDrawing = false;
    }

    // 裁剪按钮
    cropButton.addEventListener('click', () => {
      if (typeof startX === 'undefined' || typeof endX === 'undefined') {
        alert(i18nResources[currentLang]['selectArea']);
        return;
      }

      const x = Math.min(startX, endX);
      const y = Math.min(startY, endY);
      const w = Math.abs(endX - startX);
      const h = Math.abs(endY - startY);

      if (w < 10 || h < 10) {
        alert(i18nResources[currentLang]['selectLarger']);
        return;
      }

      const cropCanvas = document.createElement('canvas');
      cropCanvas.width = w;
      cropCanvas.height = h;
      const cropCtx = cropCanvas.getContext('2d');
      cropCtx.drawImage(imageCanvas, x, y, w, h, 0, 0, w, h);

      // 添加到裁剪图片数组
      const dataURL = cropCanvas.toDataURL('image/png');
      const timestamp = new Date().getTime();
      croppedImages.push({
        id: timestamp,
        dataURL: dataURL,
        width: w,
        height: h
      });

      // 更新结果显示
      updateCroppedResults();
      
      // 启用全部下载按钮
      saveAllButton.disabled = false;
      
      // 重置选择区域
      resetSelection();
    });

    // 更新裁剪结果显示
    function updateCroppedResults() {
      cropCount.textContent = croppedImages.length;
      
      if (croppedImages.length === 0) {
        croppedResults.innerHTML = `<div class="empty-state">${i18nResources[currentLang]['noResults']}</div>`;
        return;
      }
      
      let html = '';
      croppedImages.forEach((image, index) => {
        html += `
          <div class="cropped-item">
            <img src="${image.dataURL}" alt="${i18nResources[currentLang]['resultsTitle']} ${index + 1}" />
            <div class="cropped-item-actions">
              <span>${i18nResources[currentLang]['sizeLabel']}: ${image.width} × ${image.height}</span>
              <button class="download-btn" onclick="downloadImage('${image.dataURL}', 'cropped_${image.id}.png')">${i18nResources[currentLang]['downloadBtn']}</button>
              <button class="delete-btn" onclick="deleteImage(${index})">${i18nResources[currentLang]['deleteBtn']}</button>
            </div>
          </div>
        `;
      });
      
      croppedResults.innerHTML = html;
    }

    // 下载单张图片
    function downloadImage(dataUrl, filename) {
      const link = document.createElement('a');
      link.href = dataUrl;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // 删除单张图片
    function deleteImage(index) {
      croppedImages.splice(index, 1);
      updateCroppedResults();
      
      // 如果没有裁剪图片了，禁用全部下载按钮
      if (croppedImages.length === 0) {
        saveAllButton.disabled = true;
      }
    }

    // 全部下载
    saveAllButton.addEventListener('click', () => {
      if (croppedImages.length === 0) return;
      
      // 逐个下载所有图片
      croppedImages.forEach((image, index) => {
        setTimeout(() => {
          downloadImage(image.dataURL, `cropped_image_${index + 1}.png`);
        }, index * 300); // 稍微延迟以避免浏览器阻止多次下载
      });
    });

    // 重置按钮
    resetButton.addEventListener('click', resetAll);

    // 初始化显示
    updateCroppedResults();
  </script>

</body>
</html>
